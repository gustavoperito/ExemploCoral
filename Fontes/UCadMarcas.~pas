unit UCadMarcas;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, UCadObjeto, ExtCtrls, StdCtrls, Mask, Buttons, ComCtrls, Grids,
  DBGrids, DBCtrls, DB, DBClient, SimpleDS, FMTBcd, Provider, SqlExpr;

type
  TFrmCadMarcas = class(TFrmCadObjeto)
    Label1: TLabel;
    DBEnome: TDBEdit;
    Label2: TLabel;
    SQLMARCA: TSQLDataSet;
    PROVIDER: TDataSetProvider;
    CDSMARCA: TClientDataSet;
    DSMARCA: TDataSource;
    SQLMARCAIDMARCA: TIntegerField;
    SQLMARCANOME_MARCA: TStringField;
    SQLMARCASTATUS_SIS: TStringField;
    CDSMARCAIDMARCA: TIntegerField;
    CDSMARCANOME_MARCA: TStringField;
    CDSMARCASTATUS_SIS: TStringField;
    procedure BtnNovoClick(Sender: TObject);
    procedure BtnCancelarClick(Sender: TObject);
    procedure SimpleDSMarcasAfterDelete(DataSet: TDataSet);
    procedure SimpleDSMarcasAfterPost(DataSet: TDataSet);
    procedure BtnGravarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FrmCadMarcas: TFrmCadMarcas;

implementation

uses Udm;

{$R *.dfm}

procedure TFrmCadMarcas.BtnNovoClick(Sender: TObject);
begin
  //Gerando o código automaticamente no Auxiliar
  dm.auxiliar.close;
  dm.auxiliar.CommandText :=(' SELECT MAX (MARCAS.IDMARCA +1) FROM MARCAS ');
  dm.auxiliar.Open;

  //Desligando os Datasets
  CDSMARCA.close;
  SQLMARCA.close;

  //Zerando o parametro para nao trazer clientes
  SQLMARCA.ParamByName('PARIDMARCA').AsInteger:=0;

  //Abrindo os Datasets
  SQLMARCA.Open;
  CDSMARCA.Open;

  //Criando um registro em Branco(e preto) no final do arquivo
  CDSMARCA.Append;

  //Inserindo o id no cadastro
  CDSMARCA.FieldByName('IDMARCA').AsInteger := dm.auxiliar.fieldbyname('MAX').AsInteger;
  MedBusca.Text :=IntToStr(CDSMARCA.FieldByName('IDMARCA').AsInteger);

  //Atribuindo o Status
  CDSMARCASTATUS_SIS.AsString := 'A';

  inherited;
end;

procedure TFrmCadMarcas.BtnCancelarClick(Sender: TObject);
begin
  inherited;
  CDSMARCA.Cancel;
end;

procedure TFrmCadMarcas.BtnGravarClick(Sender: TObject);
begin
     //Este if testa se o DataSet está em modo de Inserção(dsinsert), se estiver roda novamente a rotina de geração da PK.
  If (CDSMARCA.State = DsInsert) Then
    Begin
      dm.auxiliar.close;
      dm.auxiliar.CommandText :=(' SELECT MAX (MARCAS.IDMARCA +1) FROM MARCAS ');
      dm.auxiliar.Open;

      CDSMARCA.FieldByName('IDMARCA').AsInteger := dm.auxiliar.fieldbyname('MAX').AsInteger;
      MedBusca.Text :=IntToStr(CDSMARCA.FieldByName('IDMARCA').AsInteger);
    End;

  try
    CDSMARCA.Post;
    CDSMARCA.ApplyUpdates(0);
  except
    ShowMessage('Erro de Gravação....');
    Exit;
  end;

  CDSMARCA.Close;
  SQLMARCA.Close;
  inherited;
end;

end.
